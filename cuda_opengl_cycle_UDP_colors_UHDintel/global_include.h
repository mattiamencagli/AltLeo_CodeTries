#include <iostream>
#include <cuda.h>
#include <cuda_runtime_api.h>
#include <cuda_gl_interop.h>

// #define DEBUG

#define WIDTH 1024
#define HEIGHT 1024
#define CHANNELS 4

#define CUDA_SAFE_CALL(ans) { gpuAssert((ans), __FILE__, __LINE__); }
inline void gpuAssert(cudaError_t code, const char *file, int line) {
    if (code != cudaSuccess) {
        std::cerr << "GPUassert: " << cudaGetErrorString(code) << " " << file << " " << line << std::endl;
        exit(code);
    }
}

#define GL_SAFE_CALL(ans) { OpenGlAssert((ans), __FILE__, __LINE__); }
inline void OpenGlAssert(GLenum code, const char *file, int line) {
    if (code != GL_NO_ERROR) {
        std::cerr << "OpenGlAssert: " << std::hex << code << " " << file << " " << line << std::endl;
        exit(code);
    }
}

__device__ __constant__ unsigned char palette_gist_ncar[256][3] = {
    {0,0,128}, {0,7,118}, {0,14,109}, {0,21,99}, {0,29,90}, {0,36,80}, {0,43,71}, {0,51,62}, 
    {0,58,52}, {0,65,43}, {0,72,33}, {0,80,24}, {0,87,15}, {0,94,5}, {0,88,22}, {0,81,38}, 
    {0,74,55}, {0,67,72}, {0,61,88}, {0,54,105}, {0,47,121}, {0,40,138}, {0,33,155}, {0,27,171}, 
    {0,20,188}, {0,13,205}, {0,6,221}, {0,0,238}, {0,14,255}, {0,28,255}, {0,42,255}, {0,56,255}, 
    {0,70,255}, {0,84,255}, {0,98,255}, {0,112,255}, {0,127,255}, {0,141,255}, {0,155,255}, {0,169,255}, 
    {0,183,255}, {0,192,255}, {0,197,255}, {0,202,255}, {0,206,255}, {0,210,255}, {0,215,255}, {0,219,255}, 
    {0,224,255}, {0,228,255}, {0,232,255}, {0,237,255}, {0,241,254}, {0,246,248}, {0,250,241}, {0,254,235}, 
    {0,254,228}, {0,254,222}, {0,253,215}, {0,253,209}, {0,252,202}, {0,252,195}, {0,251,189}, {0,251,182}, 
    {0,250,176}, {0,250,169}, {0,250,163}, {0,250,156}, {0,250,146}, {0,250,135}, {0,250,125}, {0,250,114}, 
    {0,251,104}, {0,251,93}, {0,252,83}, {0,252,73}, {0,252,62}, {0,253,52}, {0,253,41}, {0,254,31}, 
    {6,254,20}, {12,254,10}, {19,251,0}, {25,247,0}, {31,243,0}, {38,239,0}, {44,236,0}, {50,232,0}, 
    {57,228,0}, {63,224,0}, {70,221,0}, {76,217,0}, {82,213,0}, {89,209,0}, {95,206,0}, {101,209,0}, 
    {103,212,0}, {105,215,0}, {107,219,0}, {109,222,0}, {111,225,0}, {113,228,0}, {115,232,0}, {117,235,0}, 
    {119,238,0}, {121,241,0}, {123,245,0}, {125,248,3}, {127,251,7}, {132,254,11}, {136,255,15}, {141,255,19}, 
    {145,255,23}, {150,255,27}, {154,255,31}, {159,255,35}, {164,255,39}, {168,255,43}, {173,255,47}, {177,255,51}, 
    {182,255,55}, {186,255,59}, {191,255,55}, {195,255,51}, {200,255,47}, {204,255,43}, {209,255,39}, {214,255,35}, 
    {218,255,31}, {223,255,27}, {227,255,23}, {232,255,19}, {236,255,15}, {241,255,11}, {245,252,7}, {250,250,3}, 
    {255,247,0}, {255,245,0}, {255,242,0}, {255,240,0}, {255,237,0}, {255,235,0}, {255,232,0}, {255,230,0}, 
    {255,227,0}, {255,225,0}, {255,222,0}, {255,220,0}, {255,218,0}, {255,215,1}, {255,213,2}, {255,210,3}, 
    {255,208,4}, {255,205,5}, {255,203,6}, {255,200,7}, {255,198,8}, {255,195,9}, {255,193,10}, {255,190,11}, 
    {255,188,12}, {255,185,13}, {255,177,13}, {255,169,12}, {255,161,11}, {255,153,10}, {255,145,9}, {255,136,8}, 
    {255,128,7}, {255,120,6}, {255,112,5}, {255,104,4}, {255,95,3}, {255,87,2}, {255,79,1}, {255,71,0}, 
    {255,66,0}, {255,61,0}, {255,57,0}, {255,52,0}, {255,47,0}, {255,42,0}, {255,38,0}, {255,33,0}, 
    {255,28,0}, {255,23,0}, {255,19,0}, {255,14,0}, {255,9,0}, {255,4,17}, {255,0,35}, {255,0,53}, 
    {255,0,70}, {255,0,88}, {255,0,106}, {255,0,123}, {255,0,141}, {255,0,159}, {255,0,177}, {255,0,194}, 
    {255,0,212}, {255,0,230}, {255,0,248}, {248,3,251}, {241,6,255}, {234,10,255}, {227,13,255}, {220,17,255}, 
    {213,20,255}, {206,24,255}, {199,27,255}, {193,30,255}, {186,34,255}, {179,37,255}, {172,41,255}, {165,44,254}, 
    {158,50,253}, {164,56,252}, {170,62,251}, {176,68,250}, {182,74,248}, {188,80,247}, {194,86,246}, {199,92,245}, 
    {205,97,244}, {211,103,242}, {217,109,241}, {223,115,240}, {229,121,239}, {235,127,238}, {236,132,238}, {236,136,239}, 
    {237,141,240}, {238,146,240}, {239,150,241}, {239,155,241}, {240,159,242}, {241,164,243}, {241,169,243}, {242,173,244}, 
    {243,178,244}, {244,183,245}, {244,187,246}, {245,192,246}, {246,197,247}, {246,201,247}, {247,206,248}, {248,210,249}, 
    {249,215,249}, {249,220,250}, {250,224,250}, {251,229,251}, {251,234,252}, {252,238,252}, {253,243,253}, {254,247,254}
};
__device__ __constant__ unsigned char palette_inferno[256][3] = {
    {0,0,3}, {0,0,4}, {0,0,6}, {1,0,7}, {1,1,9}, {1,1,11}, {2,1,14}, {2,2,16}, 
    {3,2,18}, {4,3,20}, {4,3,22}, {5,4,24}, {6,4,27}, {7,5,29}, {8,6,31}, {9,6,33}, 
    {10,7,35}, {11,7,38}, {13,8,40}, {14,8,42}, {15,9,45}, {16,9,47}, {18,10,50}, {19,10,52}, 
    {20,11,54}, {22,11,57}, {23,11,59}, {25,11,62}, {26,11,64}, {28,12,67}, {29,12,69}, {31,12,71}, 
    {32,12,74}, {34,11,76}, {36,11,78}, {38,11,80}, {39,11,82}, {41,11,84}, {43,10,86}, {45,10,88}, 
    {46,10,90}, {48,10,92}, {50,9,93}, {52,9,95}, {53,9,96}, {55,9,97}, {57,9,98}, {59,9,100}, 
    {60,9,101}, {62,9,102}, {64,9,102}, {65,9,103}, {67,10,104}, {69,10,105}, {70,10,105}, {72,11,106}, 
    {74,11,106}, {75,12,107}, {77,12,107}, {79,13,108}, {80,13,108}, {82,14,108}, {83,14,109}, {85,15,109}, 
    {87,15,109}, {88,16,109}, {90,17,109}, {91,17,110}, {93,18,110}, {95,18,110}, {96,19,110}, {98,20,110}, 
    {99,20,110}, {101,21,110}, {102,21,110}, {104,22,110}, {106,23,110}, {107,23,110}, {109,24,110}, {110,24,110}, 
    {112,25,110}, {114,25,109}, {115,26,109}, {117,27,109}, {118,27,109}, {120,28,109}, {122,28,109}, {123,29,108}, 
    {125,29,108}, {126,30,108}, {128,31,107}, {129,31,107}, {131,32,107}, {133,32,106}, {134,33,106}, {136,33,106}, 
    {137,34,105}, {139,34,105}, {141,35,105}, {142,36,104}, {144,36,104}, {145,37,103}, {147,37,103}, {149,38,102}, 
    {150,38,102}, {152,39,101}, {153,40,100}, {155,40,100}, {156,41,99}, {158,41,99}, {160,42,98}, {161,43,97}, 
    {163,43,97}, {164,44,96}, {166,44,95}, {167,45,95}, {169,46,94}, {171,46,93}, {172,47,92}, {174,48,91}, 
    {175,49,91}, {177,49,90}, {178,50,89}, {180,51,88}, {181,51,87}, {183,52,86}, {184,53,86}, {186,54,85}, 
    {187,55,84}, {189,55,83}, {190,56,82}, {191,57,81}, {193,58,80}, {194,59,79}, {196,60,78}, {197,61,77}, 
    {199,62,76}, {200,62,75}, {201,63,74}, {203,64,73}, {204,65,72}, {205,66,71}, {207,68,70}, {208,69,68}, 
    {209,70,67}, {210,71,66}, {212,72,65}, {213,73,64}, {214,74,63}, {215,75,62}, {217,77,61}, {218,78,59}, 
    {219,79,58}, {220,80,57}, {221,82,56}, {222,83,55}, {223,84,54}, {224,86,52}, {226,87,51}, {227,88,50}, 
    {228,90,49}, {229,91,48}, {230,92,46}, {230,94,45}, {231,95,44}, {232,97,43}, {233,98,42}, {234,100,40}, 
    {235,101,39}, {236,103,38}, {237,104,37}, {237,106,35}, {238,108,34}, {239,109,33}, {240,111,31}, {240,112,30}, 
    {241,114,29}, {242,116,28}, {242,117,26}, {243,119,25}, {243,121,24}, {244,122,22}, {245,124,21}, {245,126,20}, 
    {246,128,18}, {246,129,17}, {247,131,16}, {247,133,14}, {248,135,13}, {248,136,12}, {248,138,11}, {249,140,9}, 
    {249,142,8}, {249,144,8}, {250,145,7}, {250,147,6}, {250,149,6}, {250,151,6}, {251,153,6}, {251,155,6}, 
    {251,157,6}, {251,158,7}, {251,160,7}, {251,162,8}, {251,164,10}, {251,166,11}, {251,168,13}, {251,170,14}, 
    {251,172,16}, {251,174,18}, {251,176,20}, {251,177,22}, {251,179,24}, {251,181,26}, {251,183,28}, {251,185,30}, 
    {250,187,33}, {250,189,35}, {250,191,37}, {250,193,40}, {249,195,42}, {249,197,44}, {249,199,47}, {248,201,49}, 
    {248,203,52}, {248,205,55}, {247,207,58}, {247,209,60}, {246,211,63}, {246,213,66}, {245,215,69}, {245,217,72}, 
    {244,219,75}, {244,220,79}, {243,222,82}, {243,224,86}, {243,226,89}, {242,228,93}, {242,230,96}, {241,232,100}, 
    {241,233,104}, {241,235,108}, {241,237,112}, {241,238,116}, {241,240,121}, {241,242,125}, {242,243,129}, {242,244,133}, 
    {243,246,137}, {244,247,141}, {245,248,145}, {246,250,149}, {247,251,153}, {249,252,157}, {250,253,160}, {252,254,164}, 
};